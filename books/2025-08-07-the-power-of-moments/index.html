<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-08-07">
<meta name="description" content="The Power of Moments: Why Certain Experiences Have Extraordinary Impact by Chip Heath">

<title>The Power of Moments: Why Certain Experiences Have Extraordinary Impact – self halt</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-99258d85ffddbd9841977770f8edb96b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="The Power of Moments: Why Certain Experiences Have Extraordinary Impact – self halt">
<meta property="og:description" content="The Power of Moments: Why Certain Experiences Have Extraordinary Impact by Chip Heath">
<meta property="og:image" content="https://blog.hanif.io/books/2025-08-07-the-power-of-moments/The_Power_of_Moments.jpg">
<meta property="og:site_name" content="self halt">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">self halt</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Mahmood Hanif</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../books.html"> 
<span class="menu-text">book log</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">The Power of Moments: Why Certain Experiences Have Extraordinary Impact</h1>
                  <div>
        <div class="description">
          <strong>The Power of Moments: Why Certain Experiences Have Extraordinary Impact</strong> by Chip Heath
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">books</div>
                <div class="quarto-category">2025</div>
                <div class="quarto-category">Audible</div>
                <div class="quarto-category">non-fiction</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 7, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#ai-generated-content" id="toc-ai-generated-content" class="nav-link active" data-scroll-target="#ai-generated-content">AI Generated Content</a>
  <ul class="collapse">
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#overview-of-the-key-points" id="toc-overview-of-the-key-points" class="nav-link" data-scroll-target="#overview-of-the-key-points">Overview of the Key Points</a>
  <ul class="collapse">
  <li><a href="#elevation" id="toc-elevation" class="nav-link" data-scroll-target="#elevation">Elevation</a></li>
  <li><a href="#insight" id="toc-insight" class="nav-link" data-scroll-target="#insight">Insight</a></li>
  <li><a href="#pride" id="toc-pride" class="nav-link" data-scroll-target="#pride">Pride</a></li>
  <li><a href="#connection" id="toc-connection" class="nav-link" data-scroll-target="#connection">Connection</a></li>
  </ul></li>
  <li><a href="#overview-of-the-key-themes" id="toc-overview-of-the-key-themes" class="nav-link" data-scroll-target="#overview-of-the-key-themes">Overview of the Key Themes</a>
  <ul class="collapse">
  <li><a href="#the-architect-vs.-the-spectator" id="toc-the-architect-vs.-the-spectator" class="nav-link" data-scroll-target="#the-architect-vs.-the-spectator">The Architect vs.&nbsp;The Spectator</a></li>
  <li><a href="#the-peak-end-rule-and-duration-neglect" id="toc-the-peak-end-rule-and-duration-neglect" class="nav-link" data-scroll-target="#the-peak-end-rule-and-duration-neglect">The Peak-End Rule and Duration Neglect</a></li>
  <li><a href="#transitions-and-milestones" id="toc-transitions-and-milestones" class="nav-link" data-scroll-target="#transitions-and-milestones">Transitions and Milestones</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading">Further Reading</a></li>
  <li><a href="#sources" id="toc-sources" class="nav-link" data-scroll-target="#sources">Sources</a></li>
  </ul></li>
  <li><a href="#quotes" id="toc-quotes" class="nav-link" data-scroll-target="#quotes">Quotes</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="The_Power_of_Moments.jpg" class="img-fluid figure-img" style="width:60.0%"></p>
<figcaption><strong>The Power of Moments: Why Certain Experiences Have Extraordinary Impact</strong> by Chip Heath</figcaption>
</figure>
</div>
<p><sup>isbn-13: 9781501147777</sup></p>
<p><em>Audible</em></p>
<section id="ai-generated-content" class="level1 page-columns page-full">
<h1>AI Generated Content</h1>

<div class="no-row-height column-margin column-container"><div class="">
<p>Generated by <a href="../../gemini-3-pro-preview_research_9183527b.html">gemini-3-pro-preview</a></p>
</div></div><div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="generated_image_The_Power_of_Moments.jpg" class="img-fluid figure-img"></p>
<figcaption>Image generated by <a href="../../gemini-3-pro-image-preview_non-fiction_af4438ba.html">gemini-3-pro-image-preview</a></figcaption>
</figure>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>“The Power of Moments” by Chip Heath and Dan Heath explores the psychology behind the experiences that shape our lives. The authors argue that while our existence is a continuous stream of time, our memory does not record it that way. Instead, we remember our lives as a series of “defining moments”—short, distinct experiences that stand out from the everyday. These defining moments are often characterized by transitions, milestones, peaks, or pits [1].</p>
<p>The central premise of the book is that we do not need to wait for these moments to happen by chance. By understanding the elements that make an experience memorable, individuals—whether they are parents, teachers, managers, or service providers—can actively become “architects” of their own lives and the lives of others. The book provides a practical framework for turning ordinary occurrences into extraordinary events that elevate, inspire, and connect us [1][2].</p>
</section>
<section id="overview-of-the-key-points" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-key-points">Overview of the Key Points</h2>
<p>The authors introduce the “EPIC” framework, which outlines four key elements that characterize defining moments. A powerful moment does not need to possess all four, but it usually contains at least one of these ingredients [1].</p>
<section id="elevation" class="level3">
<h3 class="anchored" data-anchor-id="elevation">Elevation</h3>
<p>Moments of elevation are experiences that rise above the routine. They provoke distinct delight and engagement. To build elevation, one must: * <strong>Boost Sensory Appeal</strong>: “Turn up the volume” on reality by making things look, taste, or feel better than usual. * <strong>Raise the Stakes</strong>: Introduce an element of productive pressure, such as a competition or a public performance. * <strong>Break the Script</strong>: Strategically violate expectations. By disrupting the routine with a surprise, one can capture attention and create a lasting memory [2].</p>
</section>
<section id="insight" class="level3">
<h3 class="anchored" data-anchor-id="insight">Insight</h3>
<p>Moments of insight rewire our understanding of ourselves or the world. These realizations can influence behavior for years. Strategies include: * <strong>Tripping Over the Truth</strong>: Instead of simply stating a problem, create a scenario where people discover the truth for themselves. This visceral realization is more powerful than a lecture. * <strong>Stretching for Insight</strong>: Mentors and leaders can help others generate insight by pushing them to “stretch”—placing them in situations where they risk failure but have the support to learn and grow [2].</p>
</section>
<section id="pride" class="level3">
<h3 class="anchored" data-anchor-id="pride">Pride</h3>
<p>Moments of pride capture us at our best, celebrating achievement and courage. * <strong>Recognize Others</strong>: Effective recognition must be personal rather than programmatic. Validating an individual’s specific contribution is far more impactful than a generic “employee of the month” award. * <strong>Multiply Milestones</strong>: Long journeys should be broken down into intermediate finish lines. This creates more opportunities for celebration and a sense of progress (e.g., the “Couch to 5k” model). * <strong>Practice Courage</strong>: Courage is often a result of preparation. By “preloading” a response to a difficult situation, individuals are more likely to act bravely when the moment arrives [2].</p>
</section>
<section id="connection" class="level3">
<h3 class="anchored" data-anchor-id="connection">Connection</h3>
<p>Moments of connection strengthen the bonds between people. * <strong>Create Shared Meaning</strong>: For groups, this involves synchronizing moments or facing a shared struggle, which builds solidarity. * <strong>Deepen Ties</strong>: For individuals, connection is fostered through responsiveness—demonstrating that one understands, validates, and cares for the other person [2].</p>
</section>
</section>
<section id="overview-of-the-key-themes" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-key-themes">Overview of the Key Themes</h2>
<section id="the-architect-vs.-the-spectator" class="level3">
<h3 class="anchored" data-anchor-id="the-architect-vs.-the-spectator">The Architect vs.&nbsp;The Spectator</h3>
<p>A recurring theme in the book is the concept of agency. Too often, people drift through life as spectators, waiting for special occasions to occur naturally. The authors challenge this passivity, asserting that anyone can be an architect of moments. By recognizing the structure of a defining moment, we can manufacture them to improve customer service, employee engagement, and personal relationships [1].</p>
</section>
<section id="the-peak-end-rule-and-duration-neglect" class="level3">
<h3 class="anchored" data-anchor-id="the-peak-end-rule-and-duration-neglect">The Peak-End Rule and Duration Neglect</h3>
<p>The authors lean on psychological research, specifically the work of Daniel Kahneman, to explain “duration neglect.” We tend to forget how long an experience lasted and instead judge it by its “peak” (the most intense moment, positive or negative) and its “end.” This theme suggests that to improve an experience, one does not need to fix every minor detail but rather focus on creating a few high peaks and a strong finish [1].</p>
</section>
<section id="transitions-and-milestones" class="level3">
<h3 class="anchored" data-anchor-id="transitions-and-milestones">Transitions and Milestones</h3>
<p>Life is naturally punctuated by transitions (graduations, new jobs, moving houses). The authors emphasize that these transitions are natural opportunities for defining moments. However, many transitions are missed opportunities—such as a lackluster first day at a new job. The book argues for spotting these natural transition points and investing effort to mark them significantly.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>“The Power of Moments” serves as a manual for escaping the “flatland” of routine. Chip and Dan Heath demonstrate that extraordinary experiences are not merely accidents of fate but are constructed from specific, replicable elements. By mastering the elements of Elevation, Insight, Pride, and Connection, we can create memories that endure, spark change, and bring us closer together. The book ultimately invites readers to pay attention to the moments that matter and to take responsibility for creating more of them.</p>
</section>
<section id="further-reading" class="level2">
<h2 class="anchored" data-anchor-id="further-reading">Further Reading</h2>
<ul>
<li><strong>“Made to Stick” by Chip Heath and Dan Heath</strong>: Also by the Heath brothers, this book explores why some ideas survive and others die, using a similar blend of psychology and practical storytelling [3].</li>
<li><strong>“The Art of Gathering” by Priya Parker</strong>: This book complements the “Connection” aspect of the Heath brothers’ work, offering a guide to making meetings, parties, and events more meaningful [3].</li>
<li><strong>“Unreasonable Hospitality” by Will Guidara</strong>: A real-world application of the “Elevation” principle, detailing how a restaurant achieved world-class status by creating bespoke moments for guests [3].</li>
<li><strong>“Thinking, Fast and Slow” by Daniel Kahneman</strong>: The foundational text that explains the cognitive biases, such as the Peak-End Rule, that underpin the theories in <em>The Power of Moments</em> [3].</li>
</ul>
</section>
<section id="sources" class="level2">
<h2 class="anchored" data-anchor-id="sources">Sources</h2>
<ul>
<li>[1] 12min Blog: https://blog.12min.com/the-power-of-moments-summary/</li>
<li>[2] Shortform: https://www.shortform.com/blog/the-power-of-moments-book/</li>
<li>[3] Goodreads: https://www.goodreads.com/book/similar/55587025-the-power-of-moments</li>
</ul>
</section>
</section>
<section id="quotes" class="level1">
<h1>Quotes</h1>
<blockquote class="blockquote">
<p>When people assess an experience, they tend to forget or ignore its length—a phenomenon called “duration neglect.” Instead, they seem to rate the experience based on two key moments: (1) the best or worst moment, known as the “peak”; and (2) the ending. Psychologists call it the “peak-end rule.”</p>
</blockquote>
<blockquote class="blockquote">
<p>The peak-end rule holds true across many kinds of experiences. Most of the relevant studies tend to focus on short, laboratory-friendly experiences: watching film clips, enduring annoying sounds, etc. On longer time frames, peaks continue to matter but the relative importance of “endings” fades somewhat. Beginnings matter, too: When college alumni were asked about their memories from college, fully 40% of those memories came from the month of September! And beginnings and endings can blur—if you change cities for a new job, is that an ending or a beginning or both? That’s why it’s preferable to talk about transitions, which encompass both endings and beginnings. What’s indisputable is that when we assess our experiences, we don’t average our minute-by-minute sensations. Rather, we tend to remember flagship moments: the peaks, the pits, and the transitions.</p>
</blockquote>
<blockquote class="blockquote">
<p>For the sake of this book, a defining moment is a short experience that is both memorable and meaningful.</p>
</blockquote>
<blockquote class="blockquote">
<p>ELEVATION: Defining moments rise above the everyday. They provoke not just transient happiness, like laughing at a friend’s joke, but memorable delight. (You pick up the red phone and someone says, “Popsicle Hotline, we’ll be right out.”) To construct elevated moments, we must boost sensory pleasures—the Popsicles must be delivered poolside on a silver tray, of course—and, if appropriate, add an element of surprise.</p>
</blockquote>
<blockquote class="blockquote">
<p>PRIDE: Defining moments capture us at our best—moments of achievement, moments of courage.</p>
</blockquote>
<blockquote class="blockquote">
<p>INSIGHT: Defining moments rewire our understanding of ourselves or the world.</p>
</blockquote>
<blockquote class="blockquote">
<p>CONNECTION: Defining moments are social: weddings, graduations, baptisms, vacations, work triumphs, bar and bat mitzvahs, speeches, sporting events. These moments are strengthened because we share them with others.</p>
</blockquote>
<blockquote class="blockquote">
<p>What’s least commonsensical is that pits can sometimes be flipped into peaks. A study of service encounters asked customers to recall recent satisfying and dissatisfying interactions with employees of airlines, hotels, or restaurants. Almost 25% of the positive encounters cited by customers were actually employees’ responses to service failures: slow service, mistaken orders, lost reservations, delayed flights, and so on. When employees handled these situations well, they transformed a negative moment to a positive one. Every great service company is a master of service recovery.</p>
</blockquote>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/blog\.hanif\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>